/*! Spec 0.1.4 */
var Spec={};!function(){Spec={storeAllStaff:[],username:"",permission:0,lastClickedEvent:{},View:{},filter:"",defaultFilter:"hideCancelled",updateUser:function(){$.ajax({type:"GET",url:"user/"}).done(function(a){Spec.username=a.username,Spec.permission=a.permission})},dropdownActiveFix:function(){$("a").removeClass("drop-active"),$('a[href="#'+Backbone.history.fragment+'"]').addClass("drop-active")},fullShiftNumber:function(a){return a.shifts.map(function(a){return a.staff}).filter(function(a){return a}).length},changePopupColor:function(a){$("#popupTitleButton").removeClass("btn-success btn-inverse btn-warning btn-danger btn-info");var b=Spec.fullShiftNumber(a);a.cancelled===!0?$("#popupTitleButton").addClass("btn-inverse"):0===b?$("#popupTitleButton").addClass("btn-danger"):b<a.staffNeeded?$("#popupTitleButton").addClass("btn-warning"):b===a.staffNeeded?$("#popupTitleButton").addClass("btn-success"):b>a.staffNeeded&&$("#popupTitleButton").addClass("btn-info"),$("#popupStaffInfo").html(b+"/"+a.staffNeeded)},resizeMap:function(){var a=$(window).height()-30;$("#calendar").fullCalendar("option","height",a),$("#modifyCSSRule").html(".fc-view-month { height:"+(a-70)+"px !important; }")},setTimeline:function(){var a=$(".fc-agenda-slots:visible").parent(),b=a.children(".timeline");b.length<1&&(b=jQuery("<hr>").addClass("timeline"),a.prepend(b));var c=new Date,d=jQuery("#calendar").fullCalendar("getView");if(!(d.visStart<c&&d.visEnd>c))return void b.hide();b.show();var e=60*c.getHours()*60+60*c.getMinutes()+c.getSeconds(),f=e/86400,g=Math.floor(a.height()*f);if(b.css("top",g+"px"),"agendaWeek"===d.name){var h=jQuery(".fc-today:visible"),i=h.position().left+1,j=h.width()-2;b.css({left:i+"px",width:j+"px"})}},updateTimeline:function(){setInterval(function(){$(".timeline").remove(),Spec.setTimeline()},3e5)},formatAMPM:function(a){var b=a.getHours(),c=a.getMinutes(),d=b>=12?"PM":"AM";b%=12,b=b?b:12,c=10>c?"0"+c:c;var e=b+":"+c+" "+d;return e},getFormattedDate:function(a){var b=a.getFullYear(),c=(1+a.getMonth()).toString();c=c.length>1?c:"0"+c;var d=a.getDate().toString();return d=d.length>1?d:"0"+d,c+"/"+d+"/"+b},_inventoryProto:{only_suggestions:!0,suggestion_url:"inventory/all",onRemove:function(a){var b=a.data("tag-id");$.ajax({type:"POST",url:"inventory/remove",data:{eventid:Spec.lastClickedEvent._id,inventoryid:a.data("tag-id")}}).done(function(){console.log("pill with ID "+b+" removed"),Spec.setInventoryNumber(-1)})},updateAmount:function(a,b,c){$.ajax({type:"POST",url:"inventory/update",data:{eventid:Spec.lastClickedEvent._id,inventoryid:a,amount:b}}).done(c)},onDuplicate:function(a,b){return Spec._inventoryProto.updateAmount(b.id,parseInt(a.find("input").val())+1,function(){var a=$('[data-tag-id="'+b.id+'"]').find("input");a.val(parseInt(a.val())+1),$(".tag-input").val("")}),!1},extraRender:function(a,b){return b.amt||(b.amt=1),a=$(a),a.contents().first().before('<input class="tag-amt" type="number" value="'+b.amt+'" min="1">'),a.find("input").change(function(){Spec._inventoryProto.updateAmount(b.id,parseInt($(this).val()),function(){})}),Spec.setInventoryNumber(1),a},onBeforeAdd:function(a,b){return Spec._inventoryProto.extraRender(a,b)},onBeforeNewAdd:function(a,b){b.amt=1;var c=a.data("tag-id");return $.ajax({type:"POST",url:"inventory/add",data:{eventid:Spec.lastClickedEvent._id,inventoryid:a.data("tag-id")}}).done(function(){console.log("pill with ID "+c+" added")}),Spec._inventoryProto.extraRender(a,b)}},decodeEntities:function(a){var b,c=document.createElement("p");return c.innerHTML=a,b=c.textContent||c.innerText,c=null,b},generateEventSource:function(){var a={url:"events/?filter="+Spec.filter,ignoreTimezone:!1};return Spec.lastEventSource=a,a},gCalEventSource:{url:"gCalEvents/",ignoreTimezone:!1},boolGCal:!1,toggleGCalEvents:function(){Spec.boolGCal===!1?$("#calendar").fullCalendar("addEventSource",Spec.gCalEventSource):$("#calendar").fullCalendar("removeEventSource",Spec.gCalEventSource),Spec.boolGCal=!Spec.boolGCal},refetchEvents:function(){$("#calendar").fullCalendar("removeEventSource",Spec.lastEventSource),$("#calendar").fullCalendar("addEventSource",Spec.generateEventSource())},techTemplateUpdate:function(){$("#technician").html(Spec.lastClickedEvent.techMustStay===!1?"<b>setup and breakdown</b> only.":"<b>duration of event</b>.")},setNoteNumber:function(a,b){$("#noNote").text(_.isUndefined(b)?parseInt($("#noNote").text())+a:b)},setInventoryNumber:function(a,b){$("#noInventory").text(_.isUndefined(b)?parseInt($("#noInventory").text())+a:b)}};var a=Backbone.Router.extend({routes:{printToday:"printToday","*filter":"all"}});Spec.app=new a,Spec.app.on("route:printToday",function(){console.log("printToday")}),Spec.app.on("route:all",function(a){Spec.dropdownActiveFix(),_.isNull(a)||_.isUndefined(a)?Spec.app.navigate(Spec.defaultFilter,{trigger:!0}):Spec.filter=a,Spec.refetchEvents(),console.log(a)}),Backbone.history.start(),_.templateSettings.variable="op",$.fn.editable.defaults.mode="inline",Spec.View.Edit=Backbone.View.extend({initialize:function(){this.render(),Spec.storeEdited={},$("#title").editable(),$("#desc").editable({title:"Description",rows:4}),$("#loc").editable(),$("#startDate").editable({format:"yyyy-mm-dd",viewformat:"mm/dd/yyyy",datepicker:{weekStart:1}}),$(".bootstrap-timepicker input").timepicker({}),$(".bootstrap-timepicker input").on("show.timepicker",function(){$(this).prev().toggle()}),$("#editSpinner").spinner(),$(".x-edit-event").on("save",function(a,b){var c={};c[this.id]=b.newValue,$.extend(Spec.storeEdited,c)})},render:function(){var a={event:Spec.lastClickedEvent},b=_.template($("#edit_template").html(),a);$("#editEvent .modal-body").html(b)}}),Spec.View.Remove=Backbone.View.extend({initialize:function(){this.render()},render:function(){var a={event:Spec.lastClickedEvent},b=_.template($("#remove_template").html(),a);$("#removeEvent").html(b)}}),Spec.View.Notes=Backbone.View.extend({initialize:function(a){Spec.setNoteNumber(0,0),this.render(a),a.notes.forEach(function(a){new Spec.View.EachNote(a)})},render:function(a){var b={eventid:Spec.lastClickedEvent._id,notes:a.notes},c=_.template($("#notes_template").html(),b);$("#notes").html(c)}}),Spec.View.EachNote=Backbone.View.extend({initialize:function(a){Spec.setNoteNumber(1),this.render(a)},render:function(a){var b={eventid:Spec.lastClickedEvent._id,note:a},c=_.template($("#each_note_template").html(),b);$("#notesBody").append(c)}}),Spec.View.Staff=Backbone.View.extend({initialize:function(a){this.render(a)},render:function(a){var b={shifts:a.shifts},c=_.template($("#staff_template").html(),b);$("#staffEvent .modal-body").html(c),Spec.techTemplateUpdate(),a.shifts.forEach(function(a){new Spec.View.EachStaff({item:a})}),Spec.newRowInit(a.shifts.slice(-1)[0]),$(".combobox").combobox({placeholder:"Choose a staff"}),$("#staffSpinner").spinner(),$("#staffSpinner").on("changed",function(a,b){$.ajax({type:"POST",url:"event/spinner",data:{eventid:Spec.lastClickedEvent._id,make:b}}).done(function(){Spec.refetchEvents(),Spec.lastClickedEvent.staffNeeded=parseInt(b),Spec.changePopupColor(Spec.lastClickedEvent),console.log("event with ID "+Spec.lastClickedEvent._id+" staff number changed to "+b)})})}}),Spec.View.EachStaff=Backbone.View.extend({initialize:function(a){this.render(a)},render:function(a){var b={item:a.item},c=_.template($("#each_staff_template").html(),b);$("#staffEvent .modal-body tbody").prepend(c)}}),Spec.newRowInit=function(a){var b,c;_.isUndefined(a)?(b=Spec.formatAMPM(Spec.lastClickedEvent.start),c=Spec.formatAMPM(Spec.lastClickedEvent.end)):(b=Spec.formatAMPM(new Date(Date.parse(a.start))),c=Spec.formatAMPM(new Date(Date.parse(a.end)))),$("#timepicker5").timepicker({defaultTime:b}),$("#timepicker6").timepicker({defaultTime:c}),$(".bootstrap-timepicker input").on("show.timepicker",function(){$(this).prev().toggle()}),$(".combobox").html(""),Spec.storeAllStaff.forEach(function(a){a.name!==!1&&$(".combobox").append($("<option>",{value:a.username}).text(a.name+" ("+a.username+")"))})},$(document).ready(function(){{var a=new Date;a.getDate(),a.getMonth(),a.getFullYear()}$("#popup").modalPopover({target:"#eventButton",placement:"bottom",backdrop:!1}),$("#calendar").fullCalendar({header:{left:"prevYear,prev,next,nextYear today",center:"title",right:"month,agendaWeek,agendaDay"},editable:!1,allDaySlot:!1,allDayDefault:!1,firstDay:a.getDay(),eventBorderColor:"black",windowResize:function(){Spec.resizeMap()},eventClick:function(a){if(a.gCal===!0)return!1;Spec.lastClickedEvent=a,$("#popup").modalPopover("hide"),symbol="",a.onHold===!0&&(symbol+='<i class="icon-ban-circle"></i> '),a.video===!0&&(symbol+='<i class="icon-facetime-video"></i> '),a.audio===!0&&(symbol+='<i class="icon-volume-up"></i> '),$("#eventButton").removeClass("disabled"),Spec.changePopupColor(a),$("#popupTitle").html(symbol+Spec.decodeEntities(a.title));var b;b=_.isObject(a.desc)?"":Spec.decodeEntities(a.desc),$("#popupContentInside").html(b);try{$("#popupContentHeader").html("<b>"+defaults.dayNames[a.start.getDay()]+" | "+Spec.decodeEntities(a.loc)+'</b><br><i class="icon-time"></i> <b>'+Spec.formatAMPM(a.start)+"</b>  <i>"+Spec.formatAMPM(new Date(Date.parse(a.eventStart)))+'</i> <i class="icon-arrow-right"></i>   <i>'+Spec.formatAMPM(new Date(Date.parse(a.eventEnd)))+"</i> <b>"+Spec.formatAMPM(a.end)+"</b>")}catch(c){$("#popupContentHeader").html("<b>"+defaults.dayNames[a.start.getDay()]+" | "+Spec.decodeEntities(a.loc)+"</b>"),$.bootstrapGrowl("Time data of the event <b>"+Spec.lastClickedEvent.title+"</b> is improper. Please edit the event to make it's data type valid.",{type:"error",align:"center",delay:4e4})}finally{$("#popupContentHeader").append("<br>"+a.customer.name),_.isNumber(a.customer.phone)&&$("#popupContentHeader").append(", "+a.customer.phone)}Spec.setInventoryNumber(0,0),$("#inventory").html(""),$("#inventory").tags(_.extend(Spec._inventoryProto,{values_url:"inventory/existing/"+a._id})),$.ajax({type:"GET",url:"notes/existing/"+a._id}).done(function(a){$("#popup").modalPopover("show");new Spec.View.Notes({notes:a})})},eventRightClick:function(a,b){return b.preventDefault(),a.gCal===!0?!1:($('a[href="#cancelEvent"] span').text(a.cancelled===!1?"Cancel this event":"Uncancel this event"),void(Spec.lastClickedEvent=a))},eventRender:function(a,b){if(a.gCal!==!0){symbol="",a.onHold===!0&&(symbol+='<i class="icon-ban-circle icon-white"></i> '),a.video===!0&&(symbol+='<i class="icon-facetime-video icon-white"></i> '),a.audio===!0&&(symbol+='<i class="icon-volume-up icon-white"></i> '),b.find(".fc-event-title").html(symbol+a.title),b.contextmenu({target:"#context-menu"});var c=a.shifts.map(function(a){return a.staff}).filter(function(a){return a});c.length>0&&b.tooltip({title:"Staff: "+c.join(", ")})}},viewRender:function(){try{Spec.setTimeline(),Spec.updateTimeline()}catch(a){}},eventSources:[Spec.generateEventSource()]}),$("#calendar").fullCalendar("changeView","agendaWeek"),Spec.resizeMap(),$("#leftGroup").prependTo(".fc-header-left"),$("#rightGroup").appendTo(".fc-header-right"),$.ajax({type:"GET",url:"staff/all/"}).done(function(a){Spec.storeAllStaff=a}),$("#gCalButton").click(function(){$("#gCalButton").toggleClass("active"),Spec.toggleGCalEvents()}),$("#eventButton").click(function(){$("#eventButton").addClass("disabled"),$("#popup").modalPopover("hide")}),$("#addNote").click(function(){return $("#newNote").modal("show"),!1}),$("#newNote textarea").bind("keypress",function(a){return 13===(a.keyCode||a.which)?($("#noteSubmit").trigger("click"),!1):void 0}),$("#noteSubmit").click(function(){$("#newNote").modal("hide");var a=$("#newNote textarea").val();return""===a?!1:($.ajax({type:"POST",url:"notes/add",data:{note:a,eventid:Spec.lastClickedEvent._id}}).done(function(b){console.log("note added to event ID "+Spec.lastClickedEvent._id+": "+a);new Spec.View.EachNote({id:b.id,text:a,user:b.user,date:new Date})}),void $("#newNote textarea").val(""))}),$(".modal").on("show",function(){$("#popup").css("opacity",.7)}).on("hide",function(){$("#popup").css("opacity",1)}),Spec.updateStaffModal=function(){$.ajax({type:"GET",url:"staff/get/"+Spec.lastClickedEvent._id}).done(function(a){a.map(function(a){var b=_.findWhere(Spec.storeAllStaff,{username:a.staff});return a.staffname=_.isUndefined(b)?"":b.name,a});new Spec.View.Staff({shifts:a})})},$('a[href="#staffEvent"]').click(Spec.updateStaffModal),$('a[href="#editEvent"]').click(function(){new Spec.View.Edit}),$('a[href="#removeEvent"]').click(function(){new Spec.View.Remove}),$('a[href="#cancelEvent"]').click(function(){$.ajax({type:"POST",url:"event/cancel",data:{eventid:Spec.lastClickedEvent._id,make:!Spec.lastClickedEvent.cancelled}}).done(function(){console.log("event with ID "+Spec.lastClickedEvent._id+" cancel toggled"),Spec.refetchEvents()})}),$("body").on("click",".toggleDuration",function(){$.ajax({type:"POST",url:"event/techMustStay",data:{eventid:Spec.lastClickedEvent._id,make:!Spec.lastClickedEvent.techMustStay}}).done(function(){Spec.refetchEvents(),Spec.lastClickedEvent.techMustStay=!Spec.lastClickedEvent.techMustStay,Spec.techTemplateUpdate(),console.log("event with ID "+Spec.lastClickedEvent._id+" techMustStay toggled")})}),$("body").on("click",".toggleVideo",function(){$.ajax({type:"POST",url:"event/video",data:{eventid:Spec.lastClickedEvent._id,make:!Spec.lastClickedEvent.video}}).done(function(){Spec.refetchEvents(),Spec.lastClickedEvent.video=!Spec.lastClickedEvent.video,$("#popup").modalPopover("hide"),console.log("event with ID "+Spec.lastClickedEvent._id+" video toggled")})}),$("body").on("click",".toggleAudio",function(){$.ajax({type:"POST",url:"event/audio",data:{eventid:Spec.lastClickedEvent._id,make:!Spec.lastClickedEvent.audio}}).done(function(){Spec.refetchEvents(),Spec.lastClickedEvent.audio=!Spec.lastClickedEvent.audio,$("#popup").modalPopover("hide"),console.log("event with ID "+Spec.lastClickedEvent._id+" audio toggled")})}),$("body").on("click",".removeNote",function(){removedItem=this;var a=$(this).attr("href");return $.ajax({type:"POST",url:"notes/remove",data:{id:a,eventid:Spec.lastClickedEvent._id}}).done(function(){console.log("note removed from event ID "+Spec.lastClickedEvent.id+", ID: "+a),$(removedItem).parent().parent().remove(),Spec.setNoteNumber(-1)}),!1}),$("body").on("click","#removeEvent .btn-danger",function(){$.ajax({type:"POST",url:"event/remove",data:{eventid:Spec.lastClickedEvent._id,XMLid:Spec.lastClickedEvent.XMLid}}).done(function(){console.log("event with ID "+Spec.lastClickedEvent._id+" removed"),$("#calendar").fullCalendar("removeEvents",Spec.lastClickedEvent._id),$("#popup").modalPopover("hide"),$("#removeEvent").modal("hide")})}),$("body").on("click",".removeStaff",function(){removedItem=this;var a=$(this).attr("href");return $.ajax({type:"POST",url:"staff/remove",data:{id:a,eventid:Spec.lastClickedEvent._id}}).done(function(){Spec.lastClickedEvent.shifts.pop(),Spec.changePopupColor(Spec.lastClickedEvent),Spec.refetchEvents(),console.log("staff removed from event ID "+Spec.lastClickedEvent._id+", ID: "+a),$(removedItem).parent().parent().remove()}),!1}),$("body").on("click","#addNewStaff",function(){var a="";if(""===$(".combobox").val());else try{a=$("#staffInput").val().match(/\(([^)]+)\)/)[1]}catch(b){a=$(".combobox").val().match(/\(([^)]+)\)/)[1]}$.ajax({type:"POST",url:"staff/add",data:{staff:a,start:$("#timepicker5").val(),end:$("#timepicker6").val(),eventid:Spec.lastClickedEvent._id,eventStart:Spec.lastClickedEvent.start,eventEnd:Spec.lastClickedEvent.end}}).done(function(b){Spec.refetchEvents(),console.log("staff added to event ID "+Spec.lastClickedEvent._id+": "+b.id);{var c={id:b.id,start:b.start,end:b.end,staff:a,staffname:$("#staffInput").val().substring(0,$("#staffInput").val().indexOf("(")-1)};new Spec.View.EachStaff({item:c})}$.grep(Spec.lastClickedEvent.shifts,function(b){return b.staff===a}).length>0&&""!==a&&$.bootstrapGrowl("You have chosen this staff for another shift before, shift is added but you may want to check it again.",{type:"info",align:"center",delay:2e4}),Spec.lastClickedEvent.shifts.push(c),Spec.changePopupColor(Spec.lastClickedEvent),$(".combobox").val("")})}),Spec.updateShift=function(a,b){var c=_.find(Spec.lastClickedEvent.shifts,function(b){return b._id===a});_.isUndefined(c)||(c.staff=b)},$("body").on("click",".shiftSignUp",function(){removedItem=this;var a=$(this).attr("href");return $.ajax({type:"POST",url:"staff/shiftsignup",data:{id:a,eventid:Spec.lastClickedEvent._id}}).done(function(){Spec.updateShift(a,Spec.username),Spec.changePopupColor(Spec.lastClickedEvent),Spec.refetchEvents(),Spec.updateStaffModal()}),!1}),$("body").on("click",".shiftWithdraw",function(){removedItem=this;var a=$(this).attr("href");return $.ajax({type:"POST",url:"staff/withdraw",data:{id:a,eventid:Spec.lastClickedEvent._id}}).done(function(){Spec.updateShift(a,""),Spec.changePopupColor(Spec.lastClickedEvent),Spec.refetchEvents(),Spec.updateStaffModal()}),!1}),$("#editEvent .modal-footer .btn-primary").click(function(){var a=[$("#timepickerResStart"),$("#timepickerResEnd"),$("#timepickerEventStart"),$("#timepickerEventEnd")];a.forEach(function(a){var b={};b[a.prop("id")]=a.val(),$.extend(Spec.storeEdited,b)}),Spec.storeEdited.date=new Date(Date.parse($.trim($("#startDate").text()))),Spec.storeEdited.staffNeeded=$("#editSpinner input").val(),$.ajax({type:"POST",url:"event/edit",data:{eventid:Spec.lastClickedEvent._id,changedData:Spec.storeEdited}}).done(function(){Spec.refetchEvents(),$("#editEvent").modal("hide"),$("#popup").modalPopover("hide");var a=Spec.storeEdited.title;_.isUndefined(a)&&(a=Spec.lastClickedEvent.title),$.bootstrapGrowl("The event <b>"+a+"</b> is edited and saved.",{type:"info",align:"center",delay:2e3}),Spec.storeEdited={}})}),$("#collapseTwo").on("click shown keydown",function(){$(this).css("overflow","visible")}).on("hide",function(){$(this).css("overflow","hidden")}),$("body").on("click",".fc-widget-content",function(){$("#popup").modalPopover("hide")}),$("body").on("click",".fc-view-agendaWeek .fc-widget-header",function(a){var b=new Date($(a.target).data("timestamp"));$("#calendar").fullCalendar("gotoDate",b),$("#calendar").fullCalendar("changeView","agendaDay")}),$(document).keydown(function(a){if($(event.target).is(":not(input, textarea)"))switch(a.keyCode){case 39:$("#calendar").fullCalendar("next");break;case 37:$("#calendar").fullCalendar("prev");break;case 38:$("#calendar").fullCalendar("today")}})}),$(document).ajaxStart(function(){$("#eventButton i").removeClass("icon-book"),$("#eventButton i").addClass("icon-refresh")}),$(document).ajaxStop(function(){$("#eventButton i").removeClass("icon-refresh"),$("#eventButton i").addClass("icon-book")}),$(document).ajaxError(function(a,b,c){console.log(c.url),"gCalEvents/"==c.url.substring(0,11)&&(window.location.href=window.location.pathname+("/"!==window.location.pathname.slice(-1))?"/":"authorize")})}();