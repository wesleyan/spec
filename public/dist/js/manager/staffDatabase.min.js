/*! Spec 0.1.3 */
var splitTrim=function(a){return a.split(",").map(function(a){return a.trim()})},Staff=Backbone.Model.extend({initialize:function(){this.on("change",function(a){var b=a.changed;if("task"===Object.keys(a.changed)[0]){var c,d=a.previousAttributes(),e=splitTrim(a.get(Object.keys(a.changed)[0]));try{c=d[Object.keys(a.changed)[0]],_.isArray(c)||(c=splitTrim(c))}catch(f){}if(_.isEqual(c,e))return!1;b={task:e}}console.log("changed: "+a.get("name")+" -> "+JSON.stringify(b)),$.ajax({type:"POST",url:"/staff/db/update",data:{id:a.get("_id"),what:b}}).done(function(){})})}}),PageableStaffList=Backbone.PageableCollection.extend({model:Staff,url:"/staff/all",state:{pageSize:20},mode:"client"}),pageableStaffList=new PageableStaffList;pageableStaffList.comparator="name",pageableStaffList.sort();var plainInteger=Backgrid.IntegerCell.extend({orderSeparator:""}),strikeCell=Backgrid.Cell.extend({template:_.template("<a href='#'><%=strikes.length%></a>"),events:{click:"manageStrikes"},refreshModal:function(){var a=this;$("#strikesModal").html(_.template($("#strikesTemplate").html(),this)),$("#strikesModal #strikeSubmit").click(function(){var b=$("#strikesModal input").val();a.model.set("strikes",a.model.get("strikes").concat({date:(new Date).toISOString(),desc:b})),a.refreshModal()}),$("#strikesModal .modal-body .btn-danger").click(function(b){var c=$(b.currentTarget).data("date");a.model.set("strikes",a.model.get("strikes").filter(function(a){return a.date!==c})),a.refreshModal()})},manageStrikes:function(a){a.preventDefault(),$("#strikesModal").html(_.template($("#strikesTemplate").html(),this)),this.refreshModal(),$("#strikesModal").modal("show")},render:function(){return this.$el.html(this.template({strikes:this.model.get("strikes")})),this.delegateEvents(),this}}),columns=[{name:"",cell:"select-row",headerCell:"select-all",renderable:!0},{name:"name",label:"Name",cell:"string",direction:"ascending"},{name:"username",label:"User Name",cell:"string"},{name:"class_year",label:"Class Year",cell:plainInteger},{name:"phone",label:"Phone Number",cell:plainInteger},{name:"level",label:"Permission Level",cell:"integer"},{name:"task",label:"Task",cell:"string"},{name:"professional",label:"Professional",cell:"boolean"},{name:"trainee",label:"Trainee",cell:"boolean"},{name:"strikes",label:"Strikes",cell:strikeCell}],pageableGrid=new Backgrid.Grid({columns:columns,collection:pageableStaffList});$stuff=$(".stuff"),$stuff.append(pageableGrid.render().el);var paginator=new Backgrid.Extension.Paginator({collection:pageableStaffList});$stuff.after(paginator.render().el);var filter=new Backgrid.Extension.ClientSideFilter({collection:pageableStaffList,fields:["name"]});$stuff.before(filter.render().el),$(filter.el).css({"float":"right",margin:"20px"}),pageableStaffList.fetch({reset:!0}),$.fn.editable.defaults.mode="inline",$("#newStaff").click(function(){$("#newModal .modal-body").html(_.template($("#newTemplate").html())),$("#professional").editable({value:0,source:[{value:1,text:"Yes"},{value:0,text:"No"}]}),$("#trainee").editable({value:1,source:[{value:1,text:"Yes"},{value:0,text:"No"}]}),$(".x-add").editable({}),$("#name").editable("option","validate",function(a){return a?void 0:"Required field!"}),$("#username").editable("option","validate",function(a){return a?void 0:"Required field!"}),$("#class_year").editable("option","validate",function(a){return a?!/\d{4}/.test(a)||isNaN(new Date(a,0,1))||parseInt(a)<(new Date).getFullYear()?"Enter a valid year for this please!":void 0:"Required field!"}),$("#phone").editable("option","validate",function(a){return a?/^[0-9\-\+]{9,15}$/.test(a)?void 0:"Enter a valid phone number please!":"Required field!"}),$("#level").editable("option","validate",function(a){return a?!/\d{1}/.test(a)&&!/\d{2}/.test(a)||parseInt(a)>10||parseInt(a)<0?"Enter a valid permission level please!":void 0:"Required field!"}),$("#task").editable("option","validate",function(a){if(!a)return"Required field!";try{a=splitTrim(a)}catch(b){return"Please enter a valid list of tasks."}}),$(".x-add").on("save.newuser",function(){var a=this;setTimeout(function(){$(a).closest("tr").next().find(".x-add").editable("show")},200)}),$("#newModal").modal("show")}),$("#newModal .btn-primary").click(function(){$(".x-add").editable("submit",{url:"/staff/db/add",ajaxOptions:{dataType:"json"},success:function(a,b){if(a&&a.errors)b.error.call(this,a.errors);else if(a){pageableStaffList.fetch({reset:!0});var c="New user created! Now editables submit individually.";$("#msg").addClass("alert-success").removeClass("alert-error").html(c).show(),$("#newModal").modal("hide")}},error:function(a){var b="";a&&a.responseText?b=a.responseText:$.each(a,function(a,c){b+=a+": "+c+"<br>"}),$("#msg").removeClass("alert-success").addClass("alert-error").html(b).show()}})}),$("#deleteStaff").click(function(){var a=pageableGrid.getSelectedModels();idsToDelete=[],a.forEach(function(a){idsToDelete.push(a.get("_id"))}),$("#deleteModal ul").html(_.template($("#deleteTemplate").html(),{models:a})),$("#deleteModal").modal("show")}),$("#deleteModal .btn-danger").click(function(){idsToDelete.forEach(function(a){$.ajax({type:"POST",url:"/staff/db/delete",data:{id:a}}).done(function(){pageableStaffList.fetch({reset:!0})})}),$("#deleteModal").modal("hide")}),$(document).keydown(function(a){if($(event.target).is(":not(input, textarea)"))switch(a.keyCode){case 39:$('.backgrid-paginator a[title="Next"]').trigger("click");break;case 37:$('.backgrid-paginator a[title="Previous"]').trigger("click")}});